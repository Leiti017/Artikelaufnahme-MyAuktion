<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Artikelaufnahme</title>
  <link rel="icon" type="image/x-icon" href="/my_icon.ico">
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    body {
      min-height: 100vh;
      background:
        radial-gradient(1200px 600px at 80% -10%, #e7f1ff 0%, transparent 60%),
        linear-gradient(135deg, #0ea5e9 0%, #1d4ed8 60%, #1e293b 100%);
    }
    .glass {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.15);
    }
    .btn {
      padding:.5rem 1rem;
      border-radius:1rem;
      font-weight:600;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:0.4rem;
    }
    .btn:hover { opacity:.92; transform: translateY(-1px); }
    .btn-primary {
      background:#fff;
      color:#0f172a;
      box-shadow:0 8px 30px rgba(0,0,0,.15);
    }
    .btn-ghost {
      color:#fff;
      border:1px solid rgba(255,255,255,.35);
      background: transparent;
    }
    .input {
      width:100%;
      border-radius:.75rem;
      padding:.6rem .9rem;
      background:rgba(255,255,255,.96);
      color:#0f172a;
      outline:none;
      border:1px solid transparent;
    }
    .input:focus {
      box-shadow:0 0 0 3px rgba(59,130,246,.35);
      border-color:rgba(255,255,255,.85);
    }
    .textarea {
      width:100%;
      min-height:140px;
      border-radius:.75rem;
      padding:.6rem .9rem;
      background:rgba(255,255,255,.96);
      color:#0f172a;
      outline:none;
      border:1px solid transparent;
    }
    .textarea:focus {
      box-shadow:0 0 0 3px rgba(59,130,246,.35);
      border-color:rgba(255,255,255,.85);
    }
    .toast-wrap {
      position:fixed;
      top:12px;
      right:12px;
      z-index:9999;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .toast {
      color:#0f172a;
      background:#fff;
      border-radius:12px;
      padding:10px 14px;
      font-weight:600;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      transform-origin:top right;
      opacity:0;
      transform:scale(.92) translateY(-6px);
      transition:transform .18s ease, opacity .18s ease;
      border:1px solid rgba(0,0,0,.06);
      white-space:pre-line;
    }
    .toast.show {
      opacity:1;
      transform:scale(1) translateY(0);
    }
    .toast.info { background:#eef2ff; color:#111827; }
    .toast.ok { background:#ecfeff; color:#0f172a; }
    .toast.warn { background:#fff7ed; color:#7c2d12; }

    #progress-overlay {
      position: fixed;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.35);
      z-index: 9998;
    }
    #progress-card {
      min-width: 260px;
      max-width: 90vw;
    }
    .bar {
      height: 10px;
      width: 100%;
      background: rgba(255,255,255,.25);
      border-radius: 999px;
      overflow: hidden;
    }
    .bar > div {
      height: 100%;
      width: 0%;
      background: #fff;
      transition: width .18s ease;
    }

    #mini-log {
      position: fixed;
      right: 12px;
      bottom: 12px;
      z-index: 9997;
      width: 320px;
      max-height: 35vh;
      overflow:auto;
    }
    #mini-log .item {
      background:#ffffff;
      color:#0f172a;
      border-radius: 12px;
      padding: 8px 10px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 6px 24px rgba(0,0,0,.14);
      margin-top:8px;
      font-size: 0.9rem;
    }
    #mini-log .ok { border-left: 6px solid #10b981; }
    #mini-log .info { border-left: 6px solid #3b82f6; }
    #mini-log .warn { border-left: 6px solid #f59e0b; }
    #mini-log .muted { opacity: .8; font-size:.85rem; }

    #save-meta.saved #save-text { opacity:0; transform: scale(0.8); }
    #save-meta.saved #save-check { opacity:1; transform: scale(1); }
    #save-check { transform: scale(0); }
  </style>
</head>
<body class="text-white">
  <div id="toast-wrap" class="toast-wrap"></div>

  <div id="progress-overlay" class="flex">
    <div id="progress-card" class="glass rounded-2xl p-4 w-full max-w-sm text-white">
      <div class="font-semibold" id="progress-text">Bitte warten…</div>
      <div class="mt-3 bar"><div id="progress-bar"></div></div>
    </div>
  </div>

  <div id="mini-log"></div>

  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-3xl md:text-4xl font-bold tracking-tight">MyAuktion · Artikelaufnahme</h1>
      <!-- Badge & Export im Header entfernt -->
    </header>

    <main class="glass rounded-3xl p-6 md:p-8 shadow-xl">
      <form id="meta-form" class="grid md:grid-cols-4 gap-4 items-end" onsubmit="return false;">
        <div>
          <label class="block mb-1 text-sm opacity-80">Artikelnummer</label>
          <input id="artikelnr" name="artikelnr" type="text" inputmode="numeric" pattern="\d*" autocomplete="off" class="input" value="">
        </div>
        <div>
          <label class="block mb-1 text-sm opacity-80">Einlieferer-ID</label>
          <input id="supplier" name="supplier" type="text" inputmode="numeric" pattern="\d*" autocomplete="off" class="input" value="">
        </div>
        <div>
          <label class="block mb-1 text-sm opacity-80">Lagerort</label>
          <input id="lagerort" name="lagerort" class="input" list="lagerorte" placeholder="z. B. Haushalt/Freizeit 170A" value="">
          <datalist id="lagerorte">
            <option value="Haushalt/Freizeit 170A">
            <option value="Haushalt/Freizeit 170B">
            <option value="Haushalt/Freizeit 170C">
            <option value="Haushalt/Freizeit 170D">
          </datalist>
          <!-- Kamera-Button NUR am Handy direkt unter Lagerort -->
          <button type="button" id="open-camera-inline" class="btn btn-primary mt-2 w-full md:hidden">
            <i data-lucide="camera"></i><span>Kamera</span>
          </button>
        </div>
        <div>
          <label class="block mb-1 text-sm opacity-80">Rufpreis (€)</label>
          <input id="rufpreis" name="rufpreis" type="text" inputmode="decimal" pattern="\d*[\.,]?\d*" autocomplete="off" class="input" placeholder="z. B. 18,00">
        </div>
        <div>
          <label class="block mb-1 text-sm opacity-80">Betriebsmittel</label>
          <input id="betriebsmittel" name="betriebsmittel" type="text" class="input" placeholder="">
        </div>
        <div>
          <label class="block mb-1 text-sm opacity-80">Sortiment</label>
          <input id="sortiment" name="sortiment" list="sortiment-list" class="input" value="Vorrichten">
          <datalist id="sortiment-list">
            <option value="Vorrichten">
          </datalist>
        </div>
        <div class="flex flex-col md:items-end gap-2">
          <div class="flex items-center gap-3">
            <input id="autoinc" type="checkbox" class="h-5 w-5" checked>
            <label for="autoinc" class="text-sm opacity-90">Art.-Nr. automatisch hochzählen</label>
          </div>
          <button type="button" id="save-meta" class="btn btn-primary w-full md:w-auto relative overflow-hidden">
            <i data-lucide="save" class="w-7 h-7"></i>
            <span id="save-text">Speichern</span>
            <span id="save-check" class="absolute inset-0 flex items-center justify-center text-emerald-600 text-2xl opacity-0 transition-all duration-200">✔</span>
          </button>
        </div>

        <!-- Bezeichnung & Beschreibung direkt im Meta-Formular -->
        <div class="md:col-span-4 grid md:grid-cols-2 gap-4 pt-2">
          <div>
            <label class="block mb-1 text-sm opacity-80">Bezeichnung</label>
            <input id="titleInput" class="input" placeholder="Marke Produktbezeichnung Typ">
          </div>
          <div>
            <label class="block mb-1 text-sm opacity-80">Beschreibung</label>
            <textarea id="descInput" class="textarea" placeholder="Kurzbeschreibung …"></textarea>
          </div>
        </div>
        <div class="md:col-span-4 flex justify-between items-center">
          <div class="text-sm opacity-80">
            Bezeichnung &amp; Beschreibung werden bei neuen Fotos automatisch von der KI vorgeschlagen und hier übernommen.
          </div>
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="auto-apply-suggest" type="checkbox" class="h-5 w-5" checked>
            Vorschlag automatisch übernehmen
          </label>
        </div>
      </form>

      <hr class="my-6 border-white/20">

      <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-4">
          <h2 class="text-xl font-semibold">Foto aufnehmen / hochladen</h2>

          <div class="flex flex-wrap gap-3">
            <button id="open-camera" class="btn btn-primary">
              <i data-lucide="camera"></i><span>Kamera</span>
            </button>
            <label class="btn btn-ghost cursor-pointer">
              <i data-lucide="upload"></i><span>Datei wählen</span>
              <input id="file-input" type="file" accept="image/*" class="hidden" multiple>
            </label>
            <label class="inline-flex items-center gap-2 text-sm opacity-90">
              <input id="serial-mode" type="checkbox" class="h-5 w-5">
              Serienaufnahme
            </label>
          </div>

          <div class="flex flex-wrap gap-4 mt-1">
            <label class="inline-flex items-center gap-2 text-sm opacity-90">
              <input id="remove-bg" type="checkbox" class="h-5 w-5" checked>
              Hintergrund entfernen
            </label>
            <label class="inline-flex items-center gap-2 text-sm opacity-90">
              <input id="add-shadow" type="checkbox" class="h-5 w-5" checked>
              Schatten hinzufügen
            </label>
            <button id="refreistellen" class="btn btn-ghost">
              <i data-lucide="bot"></i><span>Neu freistellen (letztes Bild)</span>
            </button>
          </div>

          <div id="last-shot" class="mt-3 glass rounded-xl p-3 flex items-center gap-3">
            <div class="text-sm">
              <div class="opacity-80">Zuletzt aufgenommener Artikel</div>
              <div id="last-artnr" class="text-lg font-semibold">–</div>
            </div>
            <img id="last-thumb" src="" class="w-20 h-20 object-cover rounded-lg border border-white/20 ml-auto" alt="Letztes Vorschaubild">
          </div>
        </div>

        <div>
          <h2 class="text-xl font-semibold mb-3">Bild-Vorschau</h2>
          <div id="preview-wrap" class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="glass rounded-xl p-3">
              <div class="text-sm opacity-90 mb-2">Original</div>
              <img id="preview-raw" src="" class="w-full h-64 object-contain rounded-lg bg-white" alt="Original-Vorschau">
            </div>
            <div class="glass rounded-xl p-3">
              <div class="text-sm opacity-90 mb-2">Optimiert</div>
              <img id="preview-proc" src="" class="w-full h-64 object-contain rounded-lg bg-white" alt="Optimierte Vorschau">
            </div>
          </div>
        </div>
      </div>

      <hr class="my-6 border-white/20">

      <div class="mt-6">
        <h2 class="text-xl font-semibold mb-3">Bilder für Artikel <span id="gal-artnr"></span></h2>
        <div id="gallery" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
      </div>

      <hr class="my-6 border-white/20">

      <!-- Admin-Tools komplett entfernt (unsichtbar) -->

      <!-- Export ganz unten -->
      <div class="mt-4 flex flex-wrap gap-3 justify-end">
        <button id="export-csv" class="btn btn-ghost">
          <i data-lucide="table"></i><span>Artikel-CSV Export</span>
        </button>
        <button id="export-images" class="btn btn-ghost">
          <i data-lucide="archive"></i><span>Bilder-ZIP Export</span>
        </button>
        <button id="export-all" onclick="window.location.href='/api/export_excel'" class="btn btn-ghost">
          <i data-lucide="table"></i><span>Gesamtartikel-Export (Excel)</span>
        </button>
      </div>

    </main>

    <footer class="mt-8 flex items-center justify-between text-white/90 text-sm md:text-base">
      <div class="flex items-center gap-2">
        <i data-lucide="gavel"></i>
        <span class="font-semibold">Programmiert von Jan Leitinger / Leiti017</span>
      </div>
      <div class="space-x-3">
        <a class="underline" href="https://www.myauktion.com" target="_blank" rel="noreferrer">www.myauktion.com</a>
        <span>·</span>
        <a class="underline" href="https://www.goldgrube.at" target="_blank" rel="noreferrer">www.goldgrube.at</a>
      </div>
    </footer>
  </div>

  <!-- Kamera Modal -->
  <div id="camera-modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 p-4 z-50">
    <div class="glass rounded-3xl w-full max-w-xl p-4">
      <div class="flex items-center justify-between mb-2">
        <h3 class="text-lg font-semibold">Kamera</h3>
        <button id="close-camera" class="btn btn-ghost">Schließen</button>
      </div>
      <video id="video" class="w-full rounded-2xl bg-black/30" autoplay playsinline></video>
      <div class="flex justify-end gap-3 mt-3">
        <button id="snap" class="btn btn-primary"><i data-lucide="circle"></i><span>Foto</span></button>
      </div>
      <canvas id="canvas" class="hidden"></canvas>
    </div>
  </div>

  <script>
    const API_BASE = '';

    function apiFetch(path, options = {}) {
      return fetch(API_BASE + path, options);
    }

    // Icons + Service Worker + Kamera-Autostart
    window.addEventListener('DOMContentLoaded', () => {
      if (window.lucide) lucide.createIcons();
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      }
      setTimeout(() => {
        const btn = document.getElementById('open-camera');
        if (btn) btn.click();
      }, 600);
    });

    const artikelInput   = document.getElementById('artikelnr');
    const supplierInput  = document.getElementById('supplier');
    const rufpreisInput  = document.getElementById('rufpreis');
    const betriebsmittelInput = document.getElementById('betriebsmittel');
    const sortimentInput = document.getElementById('sortiment');
    const autoinc        = document.getElementById('autoinc');
    const removeBg       = document.getElementById('remove-bg');
    const addShadow      = document.getElementById('add-shadow');
    const autoApply      = document.getElementById('auto-apply-suggest');
    const lagerInput     = document.getElementById('lagerort');
    const titleInput     = document.getElementById('titleInput');
    const descInput      = document.getElementById('descInput');

    const toastWrap      = document.getElementById('toast-wrap');
    const miniLog        = document.getElementById('mini-log');

    function logItem(msg, type='ok') {
      const time = new Date().toLocaleTimeString();
      const el = document.createElement('div');
      el.className = 'item ' + type;
      el.innerHTML = '<div>' + msg + '</div><div class="muted">'+ time +'</div>';
      miniLog.appendChild(el);
      miniLog.scrollTop = miniLog.scrollHeight;
    }

    const progressOverlay = document.getElementById('progress-overlay');
    const progressBar     = document.getElementById('progress-bar');
    const progressText    = document.getElementById('progress-text');
    let progressTimer = null, fakeVal = 0;

    function startProgress(text='Bitte warten…') {
      progressText.textContent = text;
      progressOverlay.style.display = 'flex';
      fakeVal = 0;
      progressBar.style.width = '0%';
      clearInterval(progressTimer);
      progressTimer = setInterval(() => {
        fakeVal = Math.min(90, fakeVal + Math.random()*7 + 2);
        progressBar.style.width = fakeVal.toFixed(0) + '%';
      }, 180);
    }
    function finishProgress() {
      clearInterval(progressTimer);
      progressBar.style.width = '100%';
      setTimeout(() => {
        progressOverlay.style.display = 'none';
        progressBar.style.width = '0%';
      }, 300);
    }

    async function fetchJSON(url, options = {}, timeoutMs = 45000) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const res = await apiFetch(url, { ...options, signal: ctrl.signal });
        let data;
        try {
          data = await res.json();
        } catch (e) {
          const text = await res.text().catch(() => "");
          const err = new Error(text || "Unerwartete Server-Antwort (kein JSON).");
          err.status = res.status;
          throw err;
        }
        if (!res.ok) {
          const err = new Error((data && (data.error || data.message)) || "Server-Fehler");
          err.status = res.status;
          err.data = data;
          throw err;
        }
        return data;
      } finally {
        clearTimeout(t);
      }
    }

    window.addEventListener('unhandledrejection', () => { try { finishProgress(); } catch(_){} });
    window.addEventListener('error', () => { try { finishProgress(); } catch(_){} });

    function showToast(msg, type='info', ms=2500, detail=null) {
      const el = document.createElement('div');
      el.className = 'toast ' + type;
      el.textContent = msg + (detail ? '\\n' + detail : '');
      toastWrap.appendChild(el);
      requestAnimationFrame(() => el.classList.add('show'));
      setTimeout(() => {
        el.classList.remove('show');
        setTimeout(() => el.remove(), 200);
      }, ms);
    }

    async function saveMeta() {
      const a  = artikelInput.value.trim();
      const s  = supplierInput.value.trim();
      const l  = lagerInput.value.trim();
      const rp = rufpreisInput.value.trim();
      const bm = betriebsmittelInput.value.trim();
      const so = (sortimentInput.value || 'Vorrichten').trim() || 'Vorrichten';
      if (!a) {
        showToast('Artikelnummer fehlt', 'warn', 2000);
        return;
      }
      await fetchJSON('/api/save_meta', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          artikelnr: a,
          supplier: s,
          lagerort: l,
          rufpreis: rp,
          betriebsmittel: bm,
          sortiment: so
        })
      });
      logItem('Metadaten gespeichert für Art.-Nr. ' + a, 'ok');
    }

    async function saveText() {
      const a = artikelInput.value.trim();
      if (!a) return;
      const t = titleInput.value.trim();
      const d = descInput.value.trim();
      await fetchJSON('/api/save_text', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ artikelnr:a, title:t, desc:d })
      });
      logItem('Text gespeichert für Art.-Nr. ' + a, 'info');
    }

    let textSaveTimer = null;
    function saveTextDebounced() {
      clearTimeout(textSaveTimer);
      textSaveTimer = setTimeout(saveText, 600);
    }

    async function loadTextForCurrent() {
      const a = artikelInput.value.trim();
      if (!a) {
        titleInput.value = '';
        descInput.value = '';
        return;
      }
      try {
        const j = await fetchJSON('/api/get_text?artikelnr=' + encodeURIComponent(a));
        titleInput.value = j.title || '';
        descInput.value  = j.desc  || '';
      } catch (e) {
        // still fine
      }
    }

    async function loadLagerortForCurrent() {
      const a = artikelInput.value.trim();
      if (!a) {
        lagerInput.value = '';
        supplierInput.value = '';
        rufpreisInput.value = '';
        betriebsmittelInput.value = '';
        sortimentInput.value = 'Vorrichten';
        return;
      }
      try {
        const j = await fetchJSON('/api/get_meta?artikelnr=' + encodeURIComponent(a));
        if ((j.lagerort || '').trim()) {
          lagerInput.value = j.lagerort;
        }
        if ((j.supplier || '').trim()) {
          supplierInput.value = j.supplier;
        }
        rufpreisInput.value = (j.rufpreis || '');
        betriebsmittelInput.value = (j.betriebsmittel || '');
        sortimentInput.value = (j.sortiment || 'Vorrichten');
      } catch(e) {}
    }

    artikelInput.addEventListener('change', async () => {
      await loadTextForCurrent();
      await loadLagerortForCurrent();
      loadGallery(artikelInput.value.trim());
    });

    titleInput.addEventListener('input', saveTextDebounced);
    descInput.addEventListener('input', saveTextDebounced);

    document.getElementById('save-meta').addEventListener('click', async () => {
      try {
        await saveMeta();
        const btn = document.getElementById('save-meta');
        btn.classList.add('saved');
        setTimeout(() => btn.classList.remove('saved'), 700);
      } catch (e) {
        showToast(e.message || 'Fehler beim Speichern', 'warn', 2500);
      }
    });

    // Kamera & Upload
    const cameraModal = document.getElementById('camera-modal');
    const openCamera  = document.getElementById('open-camera');
    const openCameraInline = document.getElementById('open-camera-inline');
    const closeCamera = document.getElementById('close-camera');
    const video       = document.getElementById('video');
    const canvas      = document.getElementById('canvas');
    const snapBtn     = document.getElementById('snap');
    const fileInput   = document.getElementById('file-input');
    const serialMode  = document.getElementById('serial-mode');

    let stream = null;

    async function startCamera() {
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          throw new Error('Kamera nicht verfügbar: getUserMedia nicht verfügbar (HTTPS/Browser)');
        }
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        cameraModal.classList.remove('hidden');
        cameraModal.classList.add('flex');
      } catch (e) {
        showToast(e.message || 'Kamera nicht verfügbar', 'warn', 3000);
        logItem('Kamera-Fehler: ' + (e.message || String(e)), 'warn');
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      cameraModal.classList.add('hidden');
      cameraModal.classList.remove('flex');
    }

    openCamera.addEventListener('click', startCamera);
    if (openCameraInline) {
      openCameraInline.addEventListener('click', () => openCamera.click());
    }
    closeCamera.addEventListener('click', stopCamera);

    function setPreview(raw, proc) {
      const rawImg  = document.getElementById('preview-raw');
      const procImg = document.getElementById('preview-proc');
      rawImg.src  = raw  ? '/raw/' + encodeURIComponent(raw)  + '?t=' + Date.now() : '';
      procImg.src = proc ? '/processed/' + encodeURIComponent(proc) + '?t=' + Date.now() : '';
    }

    function setLastCaptured(artikelnr, proc) {
      document.getElementById('last-artnr').textContent = artikelnr || '–';
      const img = document.getElementById('last-thumb');
      img.src = proc ? '/processed/' + encodeURIComponent(proc) + '?t=' + Date.now() : '';
    }

    async function uploadBase64Image(dataUrl) {
      const a = artikelInput.value.trim();
      const s = supplierInput.value.trim();
      if (!a) {
        showToast('Artikelnummer fehlt', 'warn', 2000);
        return;
      }
      startProgress('Foto wird verarbeitet …');
      try {
        const form = new FormData();
        form.append('artikelnr', a);
        form.append('supplier', s);
        form.append('remove_bg', removeBg.checked ? '1' : '0');
        form.append('shadow',    addShadow.checked ? '1' : '0');
        form.append('image_base64', dataUrl);

        const res = await apiFetch('/api/upload_base64_cam', { method:'POST', body: form });
        const j = await res.json();
        if (!res.ok || !j.ok) {
          throw new Error(j.error || 'Upload fehlgeschlagen');
        }

        if (j.suggestion && autoApply.checked) {
          titleInput.value = (j.suggestion.title || '');
          descInput.value  = (j.suggestion.desc  || '');
          await saveText();
        }

        await saveMeta();
        setPreview(j.created[0].raw, j.created[0].proc);
        setLastCaptured(j.artikelnr, j.created[0].proc);
        loadGallery(j.artikelnr);

        if (autoinc.checked && j.next_artnr) {
          artikelInput.value = j.next_artnr;
          await loadTextForCurrent();
          await loadLagerortForCurrent();
        }

        showToast('Foto gespeichert', 'ok', 1100);
        if (!serialMode.checked) {
          stopCamera();
        }
      } catch (e) {
        showToast('Upload-Fehler: ' + (e.message || 'Unbekannter Fehler'), 'warn', 3500);
      } finally {
        finishProgress();
      }
    }

    snapBtn.addEventListener('click', () => {
      if (!video.srcObject) return;
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      const dataUrl = canvas.toDataURL('image/jpeg', 0.92);
      uploadBase64Image(dataUrl);
    });

    fileInput.addEventListener('change', async (ev) => {
      const files = Array.from(ev.target.files || []);
      if (!files.length) return;
      const a = artikelInput.value.trim();
      const s = supplierInput.value.trim();
      if (!a) {
        showToast('Artikelnummer fehlt', 'warn', 2000);
        return;
      }
      startProgress('Foto wird hochgeladen …');
      try {
        const form = new FormData();
        form.append('artikelnr', a);
        form.append('supplier', s);
        form.append('remove_bg', removeBg.checked ? '1' : '0');
        form.append('shadow',    addShadow.checked ? '1' : '0');
        for (const f of files) {
          form.append('file', f);
        }
        const res = await apiFetch('/api/upload', { method:'POST', body: form });
        const j = await res.json();
        if (!res.ok || !j.ok) {
          throw new Error(j.error || 'Upload fehlgeschlagen');
        }

        if (j.suggestion && autoApply.checked) {
          titleInput.value = (j.suggestion.title || '');
          descInput.value  = (j.suggestion.desc  || '');
          await saveText();
        }

        await saveMeta();
        const first = j.created && j.created[0];
        if (first) {
          setPreview(first.raw, first.proc);
          setLastCaptured(j.artikelnr, first.proc);
        }
        loadGallery(j.artikelnr);

        if (autoinc.checked && j.next_artnr) {
          artikelInput.value = j.next_artnr;
          await loadTextForCurrent();
          await loadLagerortForCurrent();
        }

        showToast('Foto gespeichert', 'ok', 1100);
      } catch (e) {
        showToast('Upload-Fehler: ' + (e.message || 'Unbekannter Fehler'), 'warn', 3500);
      } finally {
        finishProgress();
        fileInput.value = '';
      }
    });

    document.getElementById('refreistellen').addEventListener('click', async () => {
      startProgress('Neu freistellen …');
      let j;
      try {
        j = await fetchJSON('/api/refreistellen', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            remove_bg: removeBg.checked ? '1' : '0',
            shadow:    addShadow.checked ? '1' : '0'
          })
        });
      } catch (err) {
        finishProgress();
        showToast(err.message || 'Fehler beim Neu-Freistellen', 'warn', 4000);
        logItem('Neu-Freistellen Fehler: ' + (err.message || String(err)), 'warn');
        return;
      }
      finishProgress();
      setPreview(j.raw, j.proc);
      setLastCaptured(j.artikelnr, j.proc);
      loadGallery(j.artikelnr);
      showToast('Neu freigestellt', 'ok', 1200);
      logItem('Bild '+ j.proc +' erfolgreich freigestellt', 'ok');
    });

    async function loadGallery(artikelnr) {
      const galWrap  = document.getElementById('gallery');
      const galLabel = document.getElementById('gal-artnr');
      galWrap.innerHTML = '';
      galLabel.textContent = artikelnr || '–';
      if (!artikelnr) return;
      try {
        const res = await apiFetch('/api/images?artikelnr=' + encodeURIComponent(artikelnr));
        const j   = await res.json();
        const files = j.files || [];
        if (!files.length) {
          galWrap.innerHTML = '<div class="text-white/80 col-span-full">Keine Bilder vorhanden.</div>';
          return;
        }
        for (const fn of files) {
          const card = document.createElement('div');
          card.className = 'glass rounded-xl p-2 flex flex-col gap-2';
          card.innerHTML = `
            <img src="/processed/${encodeURIComponent(fn)}?t=${Date.now()}" class="w-full aspect-square object-contain rounded-lg bg-white">
            <div class="text-xs opacity-90 truncate" title="${fn}">${fn}</div>
            <div class="flex gap-2">
              <button class="btn btn-primary flex-1" data-act="ref" data-fn="${fn}">Hintergrund entfernen</button>
              <button class="btn btn-ghost flex-1" data-act="del" data-fn="${fn}">Löschen</button>
            </div>
            <button class="btn btn-ghost w-full mt-1 text-xs" data-act="ren" data-fn="${fn}">Umbenennen (Index)</button>
          `;
          galWrap.appendChild(card);
        }

        galWrap.querySelectorAll('button[data-act="ref"]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const fn = btn.getAttribute('data-fn');
            btn.disabled = true;
            startProgress('Freistellen: ' + fn);
            let j;
            try {
              j = await fetchJSON('/api/refreistellen_one', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                  filename: fn,
                  remove_bg: removeBg.checked ? '1' : '0',
                  shadow:    addShadow.checked ? '1' : '0'
                })
              });
            } catch (err) {
              finishProgress();
              showToast(err.message || 'Freistellen fehlgeschlagen', 'warn', 4000);
              logItem('Freistellen Fehler: ' + (err.message || String(err)), 'warn');
              btn.disabled = false;
              return;
            }
            finishProgress();
            showToast('Neu freigestellt', 'ok', 1200);
            logItem('Bild '+ j.proc +' erfolgreich freigestellt', 'ok');
            setPreview(j.raw, j.proc);
            loadGallery(j.artikelnr);
            btn.disabled = false;
          });
        });

        galWrap.querySelectorAll('button[data-act="del"]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const fn = btn.getAttribute('data-fn');
            if (!confirm('Bild wirklich löschen?\n' + fn)) return;
            btn.disabled = true;
            try {
              const res = await apiFetch('/api/image', {
                method:'DELETE',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ filename: fn })
              });
              const j = await res.json();
              if (!res.ok || !j.ok) {
                showToast(j.error || 'Löschen fehlgeschlagen', 'warn', 2600);
                return;
              }
              showToast('Bild gelöscht', 'ok', 3000);
              logItem('Bild '+ fn +' gelöscht (Papierkorb)', 'info');
              loadGallery(artikelInput.value.trim());
            } finally {
              btn.disabled = false;
            }
          });
        });

        galWrap.querySelectorAll('button[data-act="ren"]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const old  = btn.getAttribute('data-fn');
            const a    = old.split('_')[0];
            const curr = parseInt(old.match(/_(\\d+)\\.jpg$/)[1], 10);
            const neu  = prompt('Neuen Index für ' + old + ' eingeben:', curr);
            if (neu === null) return;
            const newName = `${a}_${parseInt(neu,10)}.jpg`;
            if (newName === old) return;
            const res = await apiFetch('/api/rename', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ old: old, new: newName })
            });
            const j = await res.json();
            if (!res.ok || !j.ok) {
              showToast(j.error || 'Umbenennen fehlgeschlagen', 'warn', 2600);
              return;
            }
            showToast('Umbenannt', 'ok', 1000);
            logItem('Bild '+ old +' → '+ newName, 'info');
            loadGallery(a);
          });
        });
      } catch (e) {
        galWrap.innerHTML = '<div class="text-white/80 col-span-full">Fehler beim Laden.</div>';
      }
    }

    const exportCsvBtn   = document.getElementById('export-csv');
    const exportImagesBtn = document.getElementById('export-images');
    if (exportCsvBtn) {
      exportCsvBtn.addEventListener('click', () => {
        window.location.href = '/api/export_csv_articles';
      });
    }
    if (exportImagesBtn) {
      exportImagesBtn.addEventListener('click', () => {
        window.location.href = '/api/export_images_zip';
      });
    }

    (async () => {
      try {
        const r = await apiFetch('/api/last');
        const j = await r.json();
        if (j && j.ok && j.last) {
          setLastCaptured(j.last.artikelnr, j.last.proc);
          setPreview(j.last.raw, j.last.proc);
          if (j.last.artikelnr) artikelInput.value = j.last.artikelnr;
        }
      } catch(e) {}
      await loadTextForCurrent();
      await loadLagerortForCurrent();
      loadGallery(artikelInput.value.trim());
    })();
  </script>
</body>
</html>
